<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Envoie_convention</name>
        <label>Envoie convention</label>
        <locationX>2145</locationX>
        <locationY>691</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <connector>
            <targetReference>Confirmation_de_l_envoie</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>emailAddressesArray</name>
            <value>
                <elementReference>EmailsList</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>emailBody</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <elementReference>emailSubject</elementReference>
            </value>
        </inputParameters>
        <nameSegment>emailSimple</nameSegment>
        <versionSegment>1</versionSegment>
    </actionCalls>
    <apiVersion>54.0</apiVersion>
    <assignments>
        <name>Destinataire_AIP</name>
        <label>Destinataire AIP</label>
        <locationX>1834</locationX>
        <locationY>559</locationY>
        <assignmentItems>
            <assignToReference>EmailsList</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>getIndividuPanelisteAIP.Composition_du_foyer__r.Email</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Envoie_convention</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Destinataire_AIP_0</name>
        <label>Destinataire AIP</label>
        <locationX>1141</locationX>
        <locationY>833</locationY>
        <assignmentItems>
            <assignToReference>EmailsList</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>For_each_individu_paneliste_PaME.Composition_du_foyer__r.Email</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>For_each_individu_paneliste_PaME</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>DestinataireMMT</name>
        <label>Destinataire MMT</label>
        <locationX>1818</locationX>
        <locationY>304</locationY>
        <assignmentItems>
            <assignToReference>EmailsList</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>getFoyerPaneliste.Foyer__r.Personne_de_reference__r.Email</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Envoie_convention</targetReference>
        </connector>
    </assignments>
    <constants>
        <name>emailSubject</name>
        <dataType>String</dataType>
        <value>
            <stringValue>Signature de la convention</stringValue>
        </value>
    </constants>
    <decisions>
        <name>Check_if_convention_AIP_signed</name>
        <label>Check if convention AIP signed</label>
        <locationX>1393</locationX>
        <locationY>561</locationY>
        <defaultConnector>
            <targetReference>Destinataire_AIP</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Convention not signed</defaultConnectorLabel>
        <rules>
            <name>Convention_AIP_signed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>getConventionAIP.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Convention_signee</targetReference>
            </connector>
            <label>Convention AIP signed</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_if_convention_AIP_signed_0</name>
        <label>Check if convention AIP signed</label>
        <locationX>1131</locationX>
        <locationY>1009</locationY>
        <defaultConnector>
            <targetReference>Destinataire_AIP_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Convention not signed</defaultConnectorLabel>
        <rules>
            <name>Convention_PaME_signed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>getConventionPaME.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <label>Convention PaME signed</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_if_convention_MMT_signed</name>
        <label>Check if convention MMT signed</label>
        <locationX>1375</locationX>
        <locationY>315</locationY>
        <defaultConnector>
            <targetReference>DestinataireMMT</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Convention not signed</defaultConnectorLabel>
        <rules>
            <name>Convention_MMT_signed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>getConventionMediamat</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Convention_signee</targetReference>
            </connector>
            <label>Convention MMT signed</label>
        </rules>
    </decisions>
    <decisions>
        <name>checkPanelType</name>
        <label>checkPanelType</label>
        <locationX>791</locationX>
        <locationY>483</locationY>
        <defaultConnectorLabel>Résultat par défaut</defaultConnectorLabel>
        <rules>
            <name>Mediamat</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>getFoyerPaneliste.Referentiel_Panel__r.Type_de_panel__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Médiamat</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>getConventionMediamat</targetReference>
            </connector>
            <label>Mediamat</label>
        </rules>
        <rules>
            <name>PaME</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>getFoyerPaneliste.Referentiel_Panel__r.Type_de_panel__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>PaME</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>getIndividusPanelistePaME</targetReference>
            </connector>
            <label>PaME</label>
        </rules>
        <rules>
            <name>AIP</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>getFoyerPaneliste.Referentiel_Panel__r.Type_de_panel__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>AIP</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>getIndividuPanelisteAIP</targetReference>
            </connector>
            <label>AIP</label>
        </rules>
    </decisions>
    <decisions>
        <name>IsBypassed</name>
        <label>IsBypassed</label>
        <locationX>446</locationX>
        <locationY>171</locationY>
        <defaultConnectorLabel>Résultat par défaut</defaultConnectorLabel>
        <rules>
            <name>Bypassed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$User.Bypass_flows__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Confirmer_l_envoi</targetReference>
            </connector>
            <label>Bypassed</label>
        </rules>
    </decisions>
    <interviewLabel>IndividuPaneliste {!$Flow.CurrentDateTime}</interviewLabel>
    <label>IndividuPaneliste_EnvoiConvention</label>
    <loops>
        <name>For_each_individu_paneliste_PaME</name>
        <label>For each individu paneliste PaME</label>
        <locationX>1345</locationX>
        <locationY>777</locationY>
        <collectionReference>getIndividusPanelistePaME</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>getConventionPaME</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Envoie_convention</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordLookups>
        <name>getConventionAIP</name>
        <label>getConventionAIP</label>
        <locationX>1245</locationX>
        <locationY>559</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Check_if_convention_AIP_signed</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Composition_du_foyer__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getIndividuPanelisteAIP.Composition_du_foyer__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Referentiel_convention__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getReferentielConvention.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Convention__c</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getConventionMediamat</name>
        <label>getConventionMediamat</label>
        <locationX>1093</locationX>
        <locationY>315</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Check_if_convention_MMT_signed</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Referentiel_convention__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getReferentielConvention.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Composition_du_foyer__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getFoyerPaneliste.Foyer__r.Personne_de_reference__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Convention__c</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getConventionPaME</name>
        <label>getConventionPaME</label>
        <locationX>1341</locationX>
        <locationY>1003</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Check_if_convention_AIP_signed_0</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Composition_du_foyer__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>For_each_individu_paneliste_PaME.Composition_du_foyer__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Referentiel_convention__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getReferentielConvention.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Convention__c</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getFoyerPaneliste</name>
        <label>getFoyerPaneliste</label>
        <locationX>453</locationX>
        <locationY>485</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>getReferentielConvention</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>recordId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Foyer_paneliste__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getIndividuPanelisteAIP</name>
        <label>getIndividuPanelisteAIP</label>
        <locationX>1101</locationX>
        <locationY>556</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>getConventionAIP</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Foyer_paneliste__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getFoyerPaneliste.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Date_de_chute_de_l_individu__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Individu_Paneliste__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getIndividusPanelistePaME</name>
        <label>getIndividusPanelistePaME</label>
        <locationX>965</locationX>
        <locationY>767</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>For_each_individu_paneliste_PaME</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Foyer_paneliste__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getFoyerPaneliste.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Date_de_chute_de_l_individu__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Individu_Paneliste__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getReferentielConvention</name>
        <label>getReferentielConvention</label>
        <locationX>638</locationX>
        <locationY>482</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>checkPanelType</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Statut__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Actif</stringValue>
            </value>
        </filters>
        <filters>
            <field>Referentiel_Panel__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>getFoyerPaneliste.Referentiel_Panel__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Referentiel_convention__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <screens>
        <name>Confirmation_de_l_envoie</name>
        <label>Confirmation de l&apos;envoie</label>
        <locationX>2292</locationX>
        <locationY>695</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <fields>
            <name>Message_d_envoie</name>
            <fieldText>&lt;p&gt;L&apos;email a bien été envoyé aux individus panéliste.&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Confirmer_l_envoi</name>
        <label>Confirmer l&apos;envoi</label>
        <locationX>453</locationX>
        <locationY>343</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <connector>
            <targetReference>getFoyerPaneliste</targetReference>
        </connector>
        <fields>
            <name>Message_de_confirmation</name>
            <fieldText>&lt;p&gt;Merci de confirmer l&apos;envoi de la convention.&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Suivant</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Convention_signee</name>
        <label>Convention signée</label>
        <locationX>1589</locationX>
        <locationY>416</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <fields>
            <name>MessageInfoConventionSignee</name>
            <fieldText>&lt;p&gt;La dernière version de la convention a déjà été signée pour ce panel.&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>329</locationX>
        <locationY>49</locationY>
        <connector>
            <targetReference>IsBypassed</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>emailBody</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue>Test envoie de la convention</stringValue>
        </value>
    </variables>
    <variables>
        <name>EmailsList</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>recordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
